{% extends "admin/index.html" %}
{% load i18n static %}

{% block content %}
{{ block.super }}

<!-- æ·»åŠ æ•°æ®ç®¡ç†å·¥å…· -->
<div class="module" id="data-management-tools">
    <table>
        <caption>
            <a href="#" class="section" title="{% trans 'Show/hide' %}">
                ğŸ› ï¸ æ•°æ®ç®¡ç†å·¥å…·
            </a>
        </caption>
        <tbody>
            <tr class="model-importtask">
                <th scope="row">
                    <a href="{% url 'products:import_ai_data' %}">ğŸ“¥ æ•°æ®å¯¼å…¥</a>
                </th>
                <td>å¯¼å…¥äº§å“æ•°æ®ï¼ˆæ”¯æŒAIæ ¼å¼å’Œä¼ ç»Ÿæ ¼å¼ï¼‰</td>
            </tr>
            <tr class="model-cleartool">
                <th scope="row">
                    <a href="/admin/clear-data-tool/">ğŸ—‘ï¸ æ•°æ®æ¸…ç†</a>
                </th>
                <td>æ¸…ç©ºäº§å“æ•°æ®åº“ï¼ˆå±é™©æ“ä½œï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼‰</td>
            </tr>
            <tr class="model-summary">
                <th scope="row">
                    <a href="#" onclick="showDataSummary(); return false;">ğŸ“Š æ•°æ®ç»Ÿè®¡</a>
                </th>
                <td>æŸ¥çœ‹å½“å‰æ•°æ®åº“çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- æ•°æ®ç»Ÿè®¡å¼¹çª— -->
<div id="data-summary-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%;">
        <h2>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h2>
        <div id="summary-content">
            <p>æ­£åœ¨åŠ è½½...</p>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" onclick="closeDataSummary()" class="default">å…³é—­</button>
        </div>
    </div>
</div>

<style>
#data-management-tools {
    margin-top: 20px;
}

#data-management-tools caption a {
    font-size: 1.1em;
    font-weight: bold;
}

#data-management-tools th a {
    text-decoration: none;
    font-weight: normal;
}

#data-management-tools th a:hover {
    text-decoration: underline;
}

#data-management-tools td {
    color: #666;
    font-size: 0.9em;
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 4px solid #417690;
}

.stat-number {
    font-size: 1.5em;
    font-weight: bold;
    color: #417690;
}

.stat-label {
    color: #666;
    margin-top: 5px;
    font-size: 0.9em;
}
</style>

<script>
async function showDataSummary() {
    const modal = document.getElementById('data-summary-modal');
    const content = document.getElementById('summary-content');
    
    modal.style.display = 'block';
    content.innerHTML = '<p>æ­£åœ¨åŠ è½½æ•°æ®ç»Ÿè®¡...</p>';
    
    try {
        const response = await fetch('/products/admin/data-summary/');
        const result = await response.json();
        
        if (result.success) {
            displaySummaryData(result.data);
        } else {
            content.innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥: ' + result.error + '</p>';
        }
    } catch (error) {
        content.innerHTML = '<p style="color: red;">ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
    }
}

function displaySummaryData(data) {
    const content = document.getElementById('summary-content');
    
    let html = `
        <div class="stats-summary">
            <div class="stat-item">
                <div class="stat-number">${data.total_records.toLocaleString()}</div>
                <div class="stat-label">æ€»è®°å½•æ•°</div>
            </div>
    `;
    
    for (const [categoryName, categoryData] of Object.entries(data.categories)) {
        const displayName = {
            'products': 'äº§å“',
            'attributes': 'å±æ€§',
            'metadata': 'åŸºç¡€æ•°æ®',
            'import_history': 'å¯¼å…¥å†å²'
        }[categoryName] || categoryName;
        
        html += `
            <div class="stat-item">
                <div class="stat-number">${categoryData.count.toLocaleString()}</div>
                <div class="stat-label">${displayName}</div>
            </div>
        `;
    }
    
    html += '</div>';
    
    // æ·»åŠ è¯¦ç»†ä¿¡æ¯
    html += '<h3>è¯¦ç»†ç»Ÿè®¡</h3><ul>';
    for (const [categoryName, categoryData] of Object.entries(data.categories)) {
        if (categoryData.count > 0) {
            const displayName = {
                'products': 'äº§å“æ•°æ®',
                'attributes': 'å±æ€§æ•°æ®',
                'metadata': 'åŸºç¡€æ•°æ®',
                'import_history': 'å¯¼å…¥å†å²'
            }[categoryName] || categoryName;
            
            html += `<li><strong>${displayName}</strong>: ${categoryData.count} æ¡è®°å½•<ul>`;
            for (const [detailName, detailCount] of Object.entries(categoryData.details)) {
                if (detailCount > 0) {
                    html += `<li>${detailName}: ${detailCount}</li>`;
                }
            }
            html += '</ul></li>';
        }
    }
    html += '</ul>';
    
    content.innerHTML = html;
}

function closeDataSummary() {
    document.getElementById('data-summary-modal').style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('data-summary-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDataSummary();
    }
});
</script>
{% endblock %}
