{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="clear-data-tool">
    <h1>ğŸ—‘ï¸ äº§å“æ•°æ®æ¸…ç†å·¥å…·</h1>
    <p class="help">ä¸“ä¸šçš„æ•°æ®åº“æ¸…ç†å’Œç®¡ç†å·¥å…·ï¼Œè¯·è°¨æ…æ“ä½œã€‚</p>
    
    <!-- æ•°æ®æ‘˜è¦éƒ¨åˆ† -->
    <div class="module">
        <h2>ğŸ“Š æ•°æ®åº“çŠ¶æ€æ¦‚è§ˆ</h2>
        <div class="form-row">
            <button type="button" class="default" onclick="loadDataSummary()">åˆ·æ–°æ•°æ®ç»Ÿè®¡</button>
        </div>
        
        <div id="summaryLoading" class="loading" style="display: none;">
            <p>æ­£åœ¨åŠ è½½æ•°æ®ç»Ÿè®¡...</p>
        </div>
        
        <div id="summaryContent" style="display: none;">
            <div class="stats-grid" id="statsGrid">
                <!-- ç»Ÿè®¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- æ¸…ç†æ“ä½œéƒ¨åˆ† -->
    <div class="module">
        <h2>ğŸ§¹ æ¸…ç†æ“ä½œ</h2>
        
        <div class="form-row">
            <button type="button" class="default" onclick="dryRun()">ğŸ” é¢„è§ˆåˆ é™¤æ“ä½œ</button>
            <button type="button" class="deletelink" onclick="confirmClear()" id="clearBtn">ğŸ—‘ï¸ æ‰§è¡Œæ¸…ç†</button>
        </div>
        
        <div id="operationLoading" class="loading" style="display: none;">
            <p id="operationMessage">æ­£åœ¨å¤„ç†...</p>
        </div>
        
        <div id="operationResult"></div>
    </div>
</div>

<style>
.clear-data-tool {
    max-width: 1000px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 4px;
    text-align: center;
    border-left: 4px solid #417690;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #417690;
}

.stat-label {
    color: #666;
    margin-top: 5px;
}

.loading {
    text-align: center;
    padding: 20px;
    color: #666;
}

.alert {
    padding: 15px;
    margin: 15px 0;
    border-radius: 4px;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-danger {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.delete-list {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 4px;
    padding: 15px;
    margin: 15px 0;
}

.delete-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #fed7d7;
}

.delete-item:last-child {
    border-bottom: none;
}

.form-row button {
    margin-right: 10px;
}
</style>

<script>
// è·å–CSRF Token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
           '{{ csrf_token }}';
}

// åŠ è½½æ•°æ®æ‘˜è¦
async function loadDataSummary() {
    const loading = document.getElementById('summaryLoading');
    const content = document.getElementById('summaryContent');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    
    try {
        const response = await fetch('/products/admin/data-summary/');
        const result = await response.json();
        
        if (result.success) {
            displayDataSummary(result.data);
            content.style.display = 'block';
        } else {
            showAlert('è·å–æ•°æ®æ‘˜è¦å¤±è´¥: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
    } finally {
        loading.style.display = 'none';
    }
}

// æ˜¾ç¤ºæ•°æ®æ‘˜è¦
function displayDataSummary(data) {
    const grid = document.getElementById('statsGrid');
    grid.innerHTML = '';
    
    // æ€»è®°å½•æ•°
    const totalCard = createStatCard(data.total_records.toLocaleString(), 'æ€»è®°å½•æ•°', '#417690');
    grid.appendChild(totalCard);
    
    // å„ç±»åˆ«ç»Ÿè®¡
    for (const [categoryName, categoryData] of Object.entries(data.categories)) {
        const card = createStatCard(
            categoryData.count.toLocaleString(), 
            categoryName.replace('_', ' ').toUpperCase(),
            '#28a745'
        );
        grid.appendChild(card);
    }
}

// åˆ›å»ºç»Ÿè®¡å¡ç‰‡
function createStatCard(number, label, color) {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
        <div class="stat-number" style="color: ${color}">${number}</div>
        <div class="stat-label">${label}</div>
    `;
    return card;
}

// å¹²è¿è¡Œ
async function dryRun() {
    const loading = document.getElementById('operationLoading');
    const result = document.getElementById('operationResult');
    const message = document.getElementById('operationMessage');
    
    loading.style.display = 'block';
    result.innerHTML = '';
    message.textContent = 'æ­£åœ¨åˆ†æå°†è¦åˆ é™¤çš„æ•°æ®...';
    
    try {
        const formData = new FormData();
        formData.append('action', 'dry_run');
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        
        const response = await fetch('/products/admin/clear-data/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayDryRunResult(data.data);
        } else {
            showAlert('é¢„è§ˆå¤±è´¥: ' + data.error, 'danger');
        }
    } catch (error) {
        showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
    } finally {
        loading.style.display = 'none';
    }
}

// æ˜¾ç¤ºå¹²è¿è¡Œç»“æœ
function displayDryRunResult(data) {
    const result = document.getElementById('operationResult');
    
    let html = `
        <div class="alert alert-warning">
            <h4>âš ï¸ é¢„è§ˆåˆ é™¤æ“ä½œ</h4>
            <p>ä»¥ä¸‹æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ€»è®¡ <strong>${data.total_records.toLocaleString()}</strong> æ¡è®°å½•ï¼š</p>
        </div>
        <div class="delete-list">
    `;
    
    for (const item of data.will_delete) {
        if (item.count > 0) {
            html += `
                <div class="delete-item">
                    <span>${item.name}</span>
                    <strong>${item.count.toLocaleString()} æ¡</strong>
                </div>
            `;
        }
    }
    
    html += '</div>';
    
    if (data.total_records > 0) {
        html += `
            <div class="alert alert-danger">
                <strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯é€†è½¬ï¼è¯·ç¡®è®¤æ‚¨çœŸçš„è¦åˆ é™¤æ‰€æœ‰äº§å“æ•°æ®ã€‚
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-success">
                âœ… æ•°æ®åº“å·²ç»æ˜¯ç©ºçš„ï¼Œæ— éœ€æ¸…ç†ã€‚
            </div>
        `;
        document.getElementById('clearBtn').disabled = true;
    }
    
    result.innerHTML = html;
}

// ç¡®è®¤æ¸…ç†
async function confirmClear() {
    if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰äº§å“æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
    }
    
    if (!confirm('ğŸš¨ æœ€åç¡®è®¤ï¼šæ‚¨çœŸçš„è¦åˆ é™¤æ‰€æœ‰äº§å“ã€å±æ€§ã€å“ç‰Œã€åˆ†ç±»ç­‰æ•°æ®å—ï¼Ÿ\n\nè¿™ä¸ªæ“ä½œæ— æ³•æ’¤é”€ï¼')) {
        return;
    }
    
    const loading = document.getElementById('operationLoading');
    const result = document.getElementById('operationResult');
    const message = document.getElementById('operationMessage');
    
    loading.style.display = 'block';
    result.innerHTML = '';
    message.textContent = 'æ­£åœ¨æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œè¯·ç¨å€™...';
    
    try {
        const formData = new FormData();
        formData.append('action', 'confirm');
        formData.append('csrfmiddlewaretoken', getCsrfToken());
        
        const response = await fetch('/products/admin/clear-data/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayClearResult(data.data);
            // åˆ·æ–°æ•°æ®æ‘˜è¦
            setTimeout(() => loadDataSummary(), 1000);
        } else {
            showAlert('æ¸…ç†å¤±è´¥: ' + data.error, 'danger');
        }
    } catch (error) {
        showAlert('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
    } finally {
        loading.style.display = 'none';
    }
}

// æ˜¾ç¤ºæ¸…ç†ç»“æœ
function displayClearResult(data) {
    const result = document.getElementById('operationResult');
    
    let html = `
        <div class="alert alert-success">
            <h4>âœ… æ¸…ç†å®Œæˆï¼</h4>
            <p>${data.message}</p>
        </div>
        <div class="delete-list">
            <h5>åˆ é™¤ç»Ÿè®¡ï¼š</h5>
    `;
    
    for (const [name, count] of Object.entries(data.deletion_stats)) {
        if (count > 0) {
            html += `
                <div class="delete-item">
                    <span>${name}</span>
                    <strong>${count.toLocaleString()} æ¡</strong>
                </div>
            `;
        }
    }
    
    html += '</div>';
    
    if (data.errors && data.errors.length > 0) {
        html += `
            <div class="alert alert-warning">
                <h5>âš ï¸ è­¦å‘Šä¿¡æ¯ï¼š</h5>
                <ul>
        `;
        for (const error of data.errors) {
            html += `<li>${error}</li>`;
        }
        html += '</ul></div>';
    }
    
    result.innerHTML = html;
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type) {
    const result = document.getElementById('operationResult');
    result.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®æ‘˜è¦
document.addEventListener('DOMContentLoaded', function() {
    loadDataSummary();
});
</script>
{% endblock %}
