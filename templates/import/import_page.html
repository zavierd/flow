<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品数据导入</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            padding: 40px 30px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 700;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .main-content {
            padding: 30px;
        }
        .section {
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f8fafc;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-right: 12px;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #718096;
        }
        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .progress-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .alert {
            padding: 16px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        .alert-info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .tasks-table th,
        .tasks-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tasks-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }
        .status-pending { background-color: #ffc107; color: #212529; }
        .status-processing { background-color: #17a2b8; color: white; }
        .status-completed { background-color: #28a745; color: white; }
        .status-failed { background-color: #dc3545; color: white; }
        .status-partial { background-color: #fd7e14; color: white; }
        .template-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        .file-drop-zone.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        .file-drop-zone p {
            margin: 0;
            color: #666;
        }

        /* 工具栏样式 */
        .toolbar {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .toolbar-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .toolbar-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .tool-btn.default {
            background: #6c757d;
            color: white;
        }

        .tool-btn.default:hover {
            background: #5a6268;
        }

        .tool-btn.info {
            background: #17a2b8;
            color: white;
        }

        .tool-btn.info:hover {
            background: #138496;
        }

        .tool-btn.danger {
            background: #dc3545;
            color: white;
        }

        .tool-btn.danger:hover {
            background: #c82333;
        }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>🏠 产品数据导入</h1>
                <p>智能导入系统，支持AI数据识别和多格式处理</p>
            </div>

            <div class="main-content">
                <!-- 快速操作 -->
                <div class="quick-actions">
                    <a href="/admin/" class="quick-btn" target="_blank">⚙️ 管理后台</a>
                    <button type="button" class="quick-btn" onclick="showQuickStats()">📊 数据统计</button>
                    <a href="/clear-data/" class="quick-btn" target="_blank" style="color: #e53e3e;">🗑️ 清理数据</a>
                </div>

        <!-- 模板下载区域 -->
        <div class="section">
            <h2>1. 下载产品导入模板</h2>
            <p>请选择适合的模板格式下载，按照模板格式准备产品数据：</p>

            <!-- 模板类型选择 -->
            <div class="form-group">
                <label>模板类型：</label>
                <div style="margin-top: 8px;">
                    <label style="margin-right: 20px;">
                        <input type="radio" name="templateType" value="royana_import" checked>
                        Royana传统格式（兼容现有数据）
                    </label>
                    <label>
                        <input type="radio" name="templateType" value="ai_data">
                        AI数据格式（15列标准化格式）
                    </label>
                </div>
            </div>

            <!-- 模板选项 -->
            <div class="form-group">
                <label>
                    <input type="checkbox" id="includeSample" checked>
                    包含示例数据（推荐）- 包含基于实际产品的示例数据
                </label>
            </div>

            <!-- 下载按钮 -->
            <div class="template-links">
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    📥 下载产品导入模板 (CSV)
                </button>
            </div>
            
            <!-- 模板说明 -->
            <div id="templateDescription" style="margin-top: 15px; padding: 15px; background-color: #e8f4fd; border-radius: 4px; border-left: 4px solid #007bff;">
                <div id="royanaDescription">
                    <h4>🎯 Royana传统格式特点：</h4>
                    <ul>
                        <li><strong>兼容现有数据：</strong>与现有导入流程完全兼容</li>
                        <li><strong>最少必填字段：</strong>仅需产品编码和产品描述两个必填字段</li>
                        <li><strong>多级价格支持：</strong>完整支持价格等级II、III、IV、V的价格体系</li>
                        <li><strong>智能编码解析：</strong>自动从编码中解析品牌、系列、尺寸、配置等信息</li>
                        <li><strong>完整产品体系：</strong>自动创建品牌、分类、SPU、SKU等完整数据结构</li>
                    </ul>
                </div>
                <div id="aiDescription" style="display: none;">
                    <h4>🚀 AI数据格式特点：</h4>
                    <ul>
                        <li><strong>AI模型专用：</strong>完美适配AI模型输出的15列标准化数据格式</li>
                        <li><strong>结构化程度高：</strong>所有字段都有明确的定义和验证规则</li>
                        <li><strong>5级价格体系：</strong>支持等级I到等级V的完整价格体系</li>
                        <li><strong>智能数据处理：</strong>自动处理价格格式、门板方向映射、柜体类型解析</li>
                        <li><strong>数据继承支持：</strong>支持空值继承，减少重复数据录入</li>
                        <li><strong>格式标准化：</strong>统一的字段命名和数据格式，便于批量处理</li>
                    </ul>
                </div>
                <div style="margin-top: 10px; padding: 8px; background-color: #fff3cd; border-radius: 3px;">
                    <strong>💡 提示：</strong>模板为CSV格式，包含详细的字段说明、枚举值说明和示例数据，可用Excel或任何文本编辑器打开编辑。
                </div>
            </div>
        </div>

        <!-- 数据导入区域 -->
        <div class="section">
            <h2>2. 导入产品数据</h2>

            <!-- 导入方式选择 -->
            <div class="form-group">
                <label>导入方式：</label>
                <div style="margin-top: 8px;">
                    <label style="margin-right: 20px;">
                        <input type="radio" name="importMethod" value="file">
                        📁 文件上传
                    </label>
                    <label>
                        <input type="radio" name="importMethod" value="paste" checked>
                        📋 直接粘贴（推荐）
                    </label>
                </div>
            </div>

            <form id="importForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="taskName">任务名称：</label>
                    <input type="text" id="taskName" name="name" class="form-control"
                           placeholder="留空将自动生成，如：AI数据导入_20250120_1423">
                    <small class="form-text text-muted">
                        💡 留空将根据导入方式和时间自动生成任务名称
                    </small>
                </div>

                <input type="hidden" id="taskType" name="task_type" value="products">

                <!-- 文件上传区域 -->
                <div id="fileUploadArea" class="form-group" style="display: none;">
                    <label for="file">选择产品数据文件：</label>
                    <div class="file-drop-zone" id="fileDropZone">
                        <p>📁 点击选择文件或拖拽文件到此处</p>
                        <p>支持 .xlsx, .xls, .csv 格式，最大 10MB</p>
                        <p style="font-size: 12px; color: #888;">推荐使用CSV格式以获得最佳兼容性</p>
                    </div>
                    <input type="file" id="file" name="file_path" accept=".xlsx,.xls,.csv"
                           class="form-control" style="display: none;">
                </div>

                <!-- 直接粘贴区域 -->
                <div id="pasteArea" class="form-group">
                    <label for="pasteData">粘贴AI模型输出的表格数据：</label>
                    <div style="margin-bottom: 10px; padding: 8px; background-color: #e3f2fd; border-radius: 3px; font-size: 12px;">
                        <strong>💡 使用提示：</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>直接从AI模型复制Markdown表格数据</li>
                            <li>或者从Excel/Google Sheets复制表格数据</li>
                            <li>系统会自动识别表格格式并处理</li>
                            <li>确保包含完整的表头和数据行</li>
                        </ul>
                    </div>
                    <textarea id="pasteData" name="paste_data" class="form-control"
                              rows="15" required
                              placeholder="请在此处粘贴表格数据...

示例格式：
| 产品描述 (Description) | 产品编码 (Code) | 系列 (Series) | ... |
| :--- | :--- | :--- | :--- |
| 单门底柜<br>1 door base unit<br>H.720 D.560 | N-U30-7256-L/R | N | U | ... |

或者直接粘贴从Excel复制的数据（制表符分隔）"></textarea>
                </div>

                <button type="submit" class="btn btn-success">🚀 开始导入产品数据</button>
            </form>
        </div>

        <!-- 进度显示区域 -->
        <div class="progress-container" id="progressContainer">
            <h3>导入进度</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">准备开始...</div>
        </div>

        <!-- 结果显示区域 -->
        <div id="resultContainer"></div>

        <!-- 使用说明区域 -->
        <div class="section">
            <h2>3. 使用说明</h2>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h4>📋 数据准备步骤：</h4>
                <ol>
                    <li><strong>AI识别数据：</strong>使用AI工具识别PDF图册，获得产品编码、描述、价格等数据</li>
                    <li><strong>数据整理：</strong>将AI识别的数据整理到Excel模板中</li>
                    <li><strong>必填字段：</strong>确保填写产品编码和产品描述两个必填字段</li>
                    <li><strong>价格信息：</strong>至少填写一个价格等级（II、III、IV、V）</li>
                    <li><strong>上传导入：</strong>上传Excel文件，系统自动处理并创建完整产品信息</li>
                </ol>

                <h4>🎯 支持的数据格式示例：</h4>
                <div style="background-color: white; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px;">
                    产品编码: N-U30-7256-L/R<br>
                    产品描述: 单门底柜 1 door base unit H.720 D.560<br>
                    价格等级II: 3730.00<br>
                    价格等级III: 3970.00<br>
                    备注说明: 一块可调节隔板
                </div>
            </div>
        </div>

        <!-- 任务列表区域 -->
        <div class="section">
            <h2>4. 最近的Royana导入任务</h2>
            <button onclick="loadTasks()" class="btn">🔄 刷新任务列表</button>
            <div id="tasksContainer">
                <p>正在加载任务列表...</p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTaskId = null;
        let progressInterval = null;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            setupFileDropZone();
            setupForm();
            loadTasks();
        });

        // 设置文件拖拽区域
        function setupFileDropZone() {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('file');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateFileDropZone(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDropZone(e.target.files[0]);
                }
            });
        }

        // 更新文件拖拽区域显示
        function updateFileDropZone(file) {
            const dropZone = document.getElementById('fileDropZone');
            dropZone.innerHTML = `
                <p><strong>已选择文件：</strong> ${file.name}</p>
                <p><strong>文件大小：</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <p>点击重新选择文件</p>
            `;
        }

        // 设置表单提交
        function setupForm() {
            const form = document.getElementById('importForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        // 处理表单提交
        async function handleFormSubmit(e) {
            e.preventDefault();

            const progressContainer = document.getElementById('progressContainer');
            const resultContainer = document.getElementById('resultContainer');
            const importMethod = document.querySelector('input[name="importMethod"]:checked').value;

            // 显示进度条
            progressContainer.style.display = 'block';
            resultContainer.innerHTML = '';

            try {
                let response;

                if (importMethod === 'paste') {
                    // 处理粘贴数据导入
                    const pasteData = document.getElementById('pasteData').value.trim();
                    let taskName = document.getElementById('taskName').value.trim();

                    if (!pasteData) {
                        throw new Error('请粘贴表格数据');
                    }

                    // 如果任务名称为空，自动生成
                    if (!taskName) {
                        taskName = generateDefaultTaskName();
                        document.getElementById('taskName').value = taskName;
                    }

                    // 处理粘贴的数据
                    let csvData;
                    try {
                        csvData = processPasteData(pasteData);
                        console.log('数据处理成功，准备发送到服务器');
                    } catch (error) {
                        console.error('数据处理失败:', error);
                        throw new Error(`数据格式处理失败: ${error.message}`);
                    }

                    // 获取模板类型
                    const templateType = document.querySelector('input[name="templateType"]:checked').value;

                    const formData = new FormData();
                    formData.append('name', taskName);
                    formData.append('task_type', 'products');
                    formData.append('template_type', templateType);
                    formData.append('csv_data', csvData);

                    response = await fetch('/products/ai-data/import/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                } else {
                    // 处理文件上传导入
                    let taskName = document.getElementById('taskName').value.trim();

                    // 如果任务名称为空，自动生成
                    if (!taskName) {
                        taskName = generateDefaultTaskName();
                        document.getElementById('taskName').value = taskName;
                    }

                    // 统一使用AI数据导入接口，支持文件上传
                    const formData = new FormData(e.target);

                    // 添加模板类型信息
                    const templateType = document.querySelector('input[name="templateType"]:checked').value;
                    formData.append('template_type', templateType);

                    response = await fetch('/products/ai-data/import/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCsrfToken()
                        }
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '导入任务创建失败');
                }

                const result = await response.json();

                if (importMethod === 'paste' && result.success !== undefined) {
                    // AI数据导入的直接结果
                    progressContainer.style.display = 'none';
                    if (result.success) {
                        showAlert(`✅ 导入完成！${result.message}`, 'success');
                    } else {
                        showAlert(`❌ 导入失败：${result.error}`, 'danger');
                    }
                } else {
                    // 传统导入任务，需要监控进度
                    currentTaskId = result.id || result.task_id;
                    startProgressMonitoring();
                }

            } catch (error) {
                console.error('导入错误:', error);
                showAlert('导入失败：' + error.message, 'danger');
                progressContainer.style.display = 'none';
            }
        }

        // 开始监控进度
        function startProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/import-tasks/${currentTaskId}/progress/`);
                    const data = await response.json();
                    
                    updateProgress(data);
                    
                    if (data.status === 'completed' || data.status === 'failed' || data.status === 'partial') {
                        clearInterval(progressInterval);
                        showResult(data);
                        loadTasks(); // 刷新任务列表
                    }
                } catch (error) {
                    console.error('获取进度失败:', error);
                }
            }, 2000); // 每2秒检查一次
        }

        // 更新进度显示
        function updateProgress(data) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = data.progress + '%';
            progressText.textContent = `${data.status_display} - ${data.progress.toFixed(1)}% (${data.processed_rows}/${data.total_rows})`;
        }

        // 显示结果
        function showResult(data) {
            const resultContainer = document.getElementById('resultContainer');
            let alertClass = 'alert-info';
            let message = '';
            
            if (data.status === 'completed') {
                alertClass = 'alert-success';
                message = `导入成功！共处理 ${data.total_rows} 行数据，成功 ${data.success_rows} 行。`;
            } else if (data.status === 'failed') {
                alertClass = 'alert-danger';
                message = `导入失败：${data.error_details || '未知错误'}`;
            } else if (data.status === 'partial') {
                alertClass = 'alert-info';
                message = `导入部分成功。共处理 ${data.total_rows} 行数据，成功 ${data.success_rows} 行，失败 ${data.error_rows} 行。`;
            }
            
            resultContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                    ${data.error_rows > 0 ? `<br><a href="/api/import-tasks/${currentTaskId}/download_error_report/" class="btn btn-secondary" style="margin-top: 10px;">下载错误报告</a>` : ''}
                </div>
            `;
        }

        // 加载任务列表
        async function loadTasks() {
            try {
                const response = await fetch('/api/import-tasks/?ordering=-created_at&limit=10');
                const data = await response.json();
                
                const tasksContainer = document.getElementById('tasksContainer');
                
                if (data.results && data.results.length > 0) {
                    tasksContainer.innerHTML = `
                        <table class="tasks-table">
                            <thead>
                                <tr>
                                    <th>任务名称</th>
                                    <th>类型</th>
                                    <th>状态</th>
                                    <th>进度</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.results.map(task => `
                                    <tr>
                                        <td>${task.name}</td>
                                        <td>${task.type_display}</td>
                                        <td><span class="status-badge status-${task.status}">${task.status_display}</span></td>
                                        <td>${task.progress.toFixed(1)}%</td>
                                        <td>${new Date(task.created_at).toLocaleString()}</td>
                                        <td>
                                            ${task.error_rows > 0 ? `<a href="/api/import-tasks/${task.id}/download_error_report/" class="btn btn-secondary" style="font-size: 12px; padding: 4px 8px;">错误报告</a>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    tasksContainer.innerHTML = '<p>暂无导入任务</p>';
                }
            } catch (error) {
                console.error('加载任务列表失败:', error);
            }
        }

        // 显示提示信息
        function showAlert(message, type) {
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        // 下载模板
        function downloadTemplate() {
            const includeSample = document.getElementById('includeSample').checked;
            const templateType = document.querySelector('input[name="templateType"]:checked').value;

            let url, filename;

            if (templateType === 'ai_data') {
                // AI数据格式模板
                const params = new URLSearchParams({
                    include_sample: includeSample ? 'true' : 'false'
                });
                url = `/products/ai-data/template/download/?${params.toString()}`;
                const sampleSuffix = includeSample ? '_含示例数据' : '';
                filename = `AI数据格式导入模板${sampleSuffix}.csv`;
            } else {
                // Royana传统格式模板
                const params = new URLSearchParams({
                    template_type: 'royana_import',
                    format: 'csv',
                    include_sample: includeSample ? 'true' : 'false'
                });
                url = `/products/royana/template/download/?${params.toString()}`;
                const sampleSuffix = includeSample ? '_含示例数据' : '';
                filename = `Royana整木定制产品导入模板${sampleSuffix}.csv`;
            }

            // 使用fetch下载文件
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('下载失败');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // 创建下载链接
                    const link = document.createElement('a');
                    const objectUrl = URL.createObjectURL(blob);
                    link.href = objectUrl;
                    link.download = filename;

                    // 触发下载
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // 清理URL对象
                    URL.revokeObjectURL(objectUrl);

                    // 显示成功提示
                    const templateName = templateType === 'ai_data' ? 'AI数据格式' : 'Royana传统格式';
                    showAlert(`✅ ${templateName}导入模板下载成功！请参考CSV文件中的字段说明和示例数据格式填写产品信息。`, 'success');
                })
                .catch(error => {
                    console.error('下载失败:', error);
                    showAlert('❌ 模板下载失败，请重试', 'danger');
                });
        }

        // 生成默认任务名称
        function generateDefaultTaskName() {
            const now = new Date();
            const templateType = document.querySelector('input[name="templateType"]:checked').value;
            const importMethod = document.querySelector('input[name="importMethod"]:checked').value;

            // 格式化日期时间
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');

            const dateStr = `${year}${month}${day}`;
            const timeStr = `${hour}${minute}`;

            // 根据模板类型和导入方式生成名称
            let prefix = '';
            if (templateType === 'ai_data') {
                prefix = importMethod === 'paste' ? 'AI数据粘贴导入' : 'AI数据文件导入';
            } else {
                prefix = importMethod === 'paste' ? 'Royana粘贴导入' : 'Royana文件导入';
            }

            return `${prefix}_${dateStr}_${timeStr}`;
        }

        // 导入方式切换事件
        function toggleImportMethod() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const pasteArea = document.getElementById('pasteArea');
            const fileInput = document.getElementById('file');
            const pasteInput = document.getElementById('pasteData');
            const importMethod = document.querySelector('input[name="importMethod"]:checked').value;

            if (importMethod === 'paste') {
                fileUploadArea.style.display = 'none';
                pasteArea.style.display = 'block';
                fileInput.required = false;
                pasteInput.required = true;
            } else {
                fileUploadArea.style.display = 'block';
                pasteArea.style.display = 'none';
                fileInput.required = true;
                pasteInput.required = false;
            }

            // 更新任务名称placeholder
            updateTaskNamePlaceholder();
        }

        // 更新任务名称placeholder
        function updateTaskNamePlaceholder() {
            const taskNameInput = document.getElementById('taskName');
            const defaultName = generateDefaultTaskName();
            taskNameInput.placeholder = `留空将自动生成：${defaultName}`;
        }

        // 处理粘贴数据
        function processPasteData(pasteData) {
            try {
                console.log('原始粘贴数据长度:', pasteData.length);
                console.log('原始数据前200字符:', pasteData.substring(0, 200));

                // 检测数据格式
                if (pasteData.includes('|') && (pasteData.includes('---') || pasteData.includes(':---'))) {
                    // Markdown表格格式
                    console.log('检测到Markdown表格格式');
                    const result = parseMarkdownTable(pasteData);
                    console.log('转换后CSV数据长度:', result.length);
                    console.log('转换后数据前200字符:', result.substring(0, 200));
                    return result;
                } else if (pasteData.includes('\t')) {
                    // 制表符分隔格式（Excel复制）
                    console.log('检测到制表符分隔格式');
                    return parseTabDelimitedData(pasteData);
                } else if (pasteData.includes(',')) {
                    // CSV格式
                    console.log('检测到CSV格式');
                    return pasteData;
                } else {
                    throw new Error('无法识别的数据格式，请确保数据为表格格式。支持的格式：Markdown表格、制表符分隔、CSV格式');
                }
            } catch (error) {
                console.error('数据处理错误:', error);
                throw error;
            }
        }

        // 解析Markdown表格 - 更健壮的版本
        function parseMarkdownTable(markdownData) {
            try {
                const lines = markdownData.trim().split('\n');
                const csvLines = [];

                console.log('开始解析Markdown表格，总行数:', lines.length);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    // 跳过空行
                    if (!line) {
                        continue;
                    }

                    // 跳过分隔行（包含 --- 的行）
                    if (line.includes('---') || line.includes(':---')) {
                        console.log(`跳过分隔行 ${i+1}:`, line);
                        continue;
                    }

                    // 处理表格行
                    if (line.startsWith('|') && line.endsWith('|')) {
                        console.log(`处理表格行 ${i+1}:`, line);

                        try {
                            // 移除首尾的 | 符号
                            const cellContent = line.slice(1, -1);

                            // 分割单元格，但要小心处理包含 | 的内容
                            const cells = [];
                            let currentCell = '';
                            let inQuotes = false;

                            for (let j = 0; j < cellContent.length; j++) {
                                const char = cellContent[j];

                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                    currentCell += char;
                                } else if (char === '|' && !inQuotes) {
                                    // 找到单元格分隔符
                                    cells.push(currentCell.trim());
                                    currentCell = '';
                                } else {
                                    currentCell += char;
                                }
                            }

                            // 添加最后一个单元格
                            if (currentCell !== '') {
                                cells.push(currentCell.trim());
                            }

                            // 处理每个单元格
                            const processedCells = cells.map(cell => {
                                // 清理单元格内容
                                let cleanCell = cell.trim();

                                // 处理<br>换行符 - 转换为实际换行符
                                cleanCell = cleanCell.replace(/<br\s*\/?>/gi, '\n');

                                // 处理其他HTML标签
                                cleanCell = cleanCell.replace(/<[^>]*>/g, '');

                                // 如果包含逗号、换行符或引号，用引号包围并转义内部引号
                                if (cleanCell.includes(',') || cleanCell.includes('\n') || cleanCell.includes('"')) {
                                    cleanCell = '"' + cleanCell.replace(/"/g, '""') + '"';
                                }

                                return cleanCell;
                            });

                            csvLines.push(processedCells.join(','));
                            console.log(`成功处理行 ${i+1}，单元格数:`, processedCells.length);

                        } catch (cellError) {
                            console.error(`处理行 ${i+1} 时出错:`, cellError);
                            // 继续处理下一行
                        }
                    }
                }

                console.log('Markdown表格解析完成，CSV行数:', csvLines.length);
                return csvLines.join('\n');

            } catch (error) {
                console.error('Markdown表格解析失败:', error);
                throw new Error(`Markdown表格解析失败: ${error.message}`);
            }
        }

        // 解析制表符分隔数据
        function parseTabDelimitedData(tabData) {
            const lines = tabData.trim().split('\n');
            const csvLines = [];

            for (const line of lines) {
                const cells = line.split('\t').map(cell => {
                    let cleanCell = cell.trim();
                    // 如果包含逗号或引号，用引号包围
                    if (cleanCell.includes(',') || cleanCell.includes('"')) {
                        cleanCell = '"' + cleanCell.replace(/"/g, '""') + '"';
                    }
                    return cleanCell;
                });
                csvLines.push(cells.join(','));
            }

            return csvLines.join('\n');
        }

        // 模板类型切换事件
        document.addEventListener('DOMContentLoaded', function() {
            // 模板类型切换
            const templateRadios = document.querySelectorAll('input[name="templateType"]');
            const royanaDescription = document.getElementById('royanaDescription');
            const aiDescription = document.getElementById('aiDescription');

            templateRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'ai_data') {
                        royanaDescription.style.display = 'none';
                        aiDescription.style.display = 'block';
                    } else {
                        royanaDescription.style.display = 'block';
                        aiDescription.style.display = 'none';
                    }
                    // 更新任务名称placeholder
                    updateTaskNamePlaceholder();
                });
            });

            // 导入方式切换
            const importMethodRadios = document.querySelectorAll('input[name="importMethod"]');
            importMethodRadios.forEach(radio => {
                radio.addEventListener('change', toggleImportMethod);
            });

            // 初始化导入方式和任务名称placeholder
            toggleImportMethod();
            updateTaskNamePlaceholder();
        });

        // 获取CSRF令牌
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
        // 显示快速统计
        async function showQuickStats() {
            try {
                const response = await fetch('/products/admin/data-summary/');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    let message = `📊 数据库统计信息\n\n`;
                    message += `总记录数: ${data.total_records.toLocaleString()}\n\n`;

                    for (const [categoryName, categoryData] of Object.entries(data.categories)) {
                        const displayName = {
                            'products': '产品数据',
                            'attributes': '属性数据',
                            'metadata': '基础数据',
                            'import_history': '导入历史'
                        }[categoryName] || categoryName;

                        if (categoryData.count > 0) {
                            message += `${displayName}: ${categoryData.count} 条\n`;
                            for (const [detailName, detailCount] of Object.entries(categoryData.details)) {
                                if (detailCount > 0) {
                                    message += `  • ${detailName}: ${detailCount}\n`;
                                }
                            }
                            message += '\n';
                        }
                    }

                    alert(message);
                } else {
                    alert('获取数据统计失败: ' + result.error);
                }
            } catch (error) {
                alert('网络错误: ' + error.message);
            }
        }
    </script>
</body>
</html>