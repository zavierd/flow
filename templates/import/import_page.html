<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“æ•°æ®å¯¼å…¥</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            padding: 40px 30px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 700;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .main-content {
            padding: 30px;
        }
        .section {
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f8fafc;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-right: 12px;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #718096;
        }
        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .progress-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .alert {
            padding: 16px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        .alert-info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .tasks-table th,
        .tasks-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .tasks-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }
        .status-pending { background-color: #ffc107; color: #212529; }
        .status-processing { background-color: #17a2b8; color: white; }
        .status-completed { background-color: #28a745; color: white; }
        .status-failed { background-color: #dc3545; color: white; }
        .status-partial { background-color: #fd7e14; color: white; }
        .template-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        .file-drop-zone.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        .file-drop-zone p {
            margin: 0;
            color: #666;
        }

        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .toolbar-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
        }

        .toolbar-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .tool-btn.default {
            background: #6c757d;
            color: white;
        }

        .tool-btn.default:hover {
            background: #5a6268;
        }

        .tool-btn.info {
            background: #17a2b8;
            color: white;
        }

        .tool-btn.info:hover {
            background: #138496;
        }

        .tool-btn.danger {
            background: #dc3545;
            color: white;
        }

        .tool-btn.danger:hover {
            background: #c82333;
        }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ  äº§å“æ•°æ®å¯¼å…¥</h1>
                <p>æ™ºèƒ½å¯¼å…¥ç³»ç»Ÿï¼Œæ”¯æŒAIæ•°æ®è¯†åˆ«å’Œå¤šæ ¼å¼å¤„ç†</p>
            </div>

            <div class="main-content">
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="quick-actions">
                    <a href="/admin/" class="quick-btn" target="_blank">âš™ï¸ ç®¡ç†åå°</a>
                    <button type="button" class="quick-btn" onclick="showQuickStats()">ğŸ“Š æ•°æ®ç»Ÿè®¡</button>
                    <a href="/clear-data/" class="quick-btn" target="_blank" style="color: #e53e3e;">ğŸ—‘ï¸ æ¸…ç†æ•°æ®</a>
                </div>

        <!-- æ¨¡æ¿ä¸‹è½½åŒºåŸŸ -->
        <div class="section">
            <h2>1. ä¸‹è½½äº§å“å¯¼å…¥æ¨¡æ¿</h2>
            <p>è¯·é€‰æ‹©é€‚åˆçš„æ¨¡æ¿æ ¼å¼ä¸‹è½½ï¼ŒæŒ‰ç…§æ¨¡æ¿æ ¼å¼å‡†å¤‡äº§å“æ•°æ®ï¼š</p>

            <!-- æ¨¡æ¿ç±»å‹é€‰æ‹© -->
            <div class="form-group">
                <label>æ¨¡æ¿ç±»å‹ï¼š</label>
                <div style="margin-top: 8px;">
                    <label style="margin-right: 20px;">
                        <input type="radio" name="templateType" value="royana_import" checked>
                        Royanaä¼ ç»Ÿæ ¼å¼ï¼ˆå…¼å®¹ç°æœ‰æ•°æ®ï¼‰
                    </label>
                    <label>
                        <input type="radio" name="templateType" value="ai_data">
                        AIæ•°æ®æ ¼å¼ï¼ˆ15åˆ—æ ‡å‡†åŒ–æ ¼å¼ï¼‰
                    </label>
                </div>
            </div>

            <!-- æ¨¡æ¿é€‰é¡¹ -->
            <div class="form-group">
                <label>
                    <input type="checkbox" id="includeSample" checked>
                    åŒ…å«ç¤ºä¾‹æ•°æ®ï¼ˆæ¨èï¼‰- åŒ…å«åŸºäºå®é™…äº§å“çš„ç¤ºä¾‹æ•°æ®
                </label>
            </div>

            <!-- ä¸‹è½½æŒ‰é’® -->
            <div class="template-links">
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    ğŸ“¥ ä¸‹è½½äº§å“å¯¼å…¥æ¨¡æ¿ (CSV)
                </button>
            </div>
            
            <!-- æ¨¡æ¿è¯´æ˜ -->
            <div id="templateDescription" style="margin-top: 15px; padding: 15px; background-color: #e8f4fd; border-radius: 4px; border-left: 4px solid #007bff;">
                <div id="royanaDescription">
                    <h4>ğŸ¯ Royanaä¼ ç»Ÿæ ¼å¼ç‰¹ç‚¹ï¼š</h4>
                    <ul>
                        <li><strong>å…¼å®¹ç°æœ‰æ•°æ®ï¼š</strong>ä¸ç°æœ‰å¯¼å…¥æµç¨‹å®Œå…¨å…¼å®¹</li>
                        <li><strong>æœ€å°‘å¿…å¡«å­—æ®µï¼š</strong>ä»…éœ€äº§å“ç¼–ç å’Œäº§å“æè¿°ä¸¤ä¸ªå¿…å¡«å­—æ®µ</li>
                        <li><strong>å¤šçº§ä»·æ ¼æ”¯æŒï¼š</strong>å®Œæ•´æ”¯æŒä»·æ ¼ç­‰çº§IIã€IIIã€IVã€Vçš„ä»·æ ¼ä½“ç³»</li>
                        <li><strong>æ™ºèƒ½ç¼–ç è§£æï¼š</strong>è‡ªåŠ¨ä»ç¼–ç ä¸­è§£æå“ç‰Œã€ç³»åˆ—ã€å°ºå¯¸ã€é…ç½®ç­‰ä¿¡æ¯</li>
                        <li><strong>å®Œæ•´äº§å“ä½“ç³»ï¼š</strong>è‡ªåŠ¨åˆ›å»ºå“ç‰Œã€åˆ†ç±»ã€SPUã€SKUç­‰å®Œæ•´æ•°æ®ç»“æ„</li>
                    </ul>
                </div>
                <div id="aiDescription" style="display: none;">
                    <h4>ğŸš€ AIæ•°æ®æ ¼å¼ç‰¹ç‚¹ï¼š</h4>
                    <ul>
                        <li><strong>AIæ¨¡å‹ä¸“ç”¨ï¼š</strong>å®Œç¾é€‚é…AIæ¨¡å‹è¾“å‡ºçš„15åˆ—æ ‡å‡†åŒ–æ•°æ®æ ¼å¼</li>
                        <li><strong>ç»“æ„åŒ–ç¨‹åº¦é«˜ï¼š</strong>æ‰€æœ‰å­—æ®µéƒ½æœ‰æ˜ç¡®çš„å®šä¹‰å’ŒéªŒè¯è§„åˆ™</li>
                        <li><strong>5çº§ä»·æ ¼ä½“ç³»ï¼š</strong>æ”¯æŒç­‰çº§Iåˆ°ç­‰çº§Vçš„å®Œæ•´ä»·æ ¼ä½“ç³»</li>
                        <li><strong>æ™ºèƒ½æ•°æ®å¤„ç†ï¼š</strong>è‡ªåŠ¨å¤„ç†ä»·æ ¼æ ¼å¼ã€é—¨æ¿æ–¹å‘æ˜ å°„ã€æŸœä½“ç±»å‹è§£æ</li>
                        <li><strong>æ•°æ®ç»§æ‰¿æ”¯æŒï¼š</strong>æ”¯æŒç©ºå€¼ç»§æ‰¿ï¼Œå‡å°‘é‡å¤æ•°æ®å½•å…¥</li>
                        <li><strong>æ ¼å¼æ ‡å‡†åŒ–ï¼š</strong>ç»Ÿä¸€çš„å­—æ®µå‘½åå’Œæ•°æ®æ ¼å¼ï¼Œä¾¿äºæ‰¹é‡å¤„ç†</li>
                    </ul>
                </div>
                <div style="margin-top: 10px; padding: 8px; background-color: #fff3cd; border-radius: 3px;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>æ¨¡æ¿ä¸ºCSVæ ¼å¼ï¼ŒåŒ…å«è¯¦ç»†çš„å­—æ®µè¯´æ˜ã€æšä¸¾å€¼è¯´æ˜å’Œç¤ºä¾‹æ•°æ®ï¼Œå¯ç”¨Excelæˆ–ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ç¼–è¾‘ã€‚
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯¼å…¥åŒºåŸŸ -->
        <div class="section">
            <h2>2. å¯¼å…¥äº§å“æ•°æ®</h2>

            <!-- å¯¼å…¥æ–¹å¼é€‰æ‹© -->
            <div class="form-group">
                <label>å¯¼å…¥æ–¹å¼ï¼š</label>
                <div style="margin-top: 8px;">
                    <label style="margin-right: 20px;">
                        <input type="radio" name="importMethod" value="file">
                        ğŸ“ æ–‡ä»¶ä¸Šä¼ 
                    </label>
                    <label>
                        <input type="radio" name="importMethod" value="paste" checked>
                        ğŸ“‹ ç›´æ¥ç²˜è´´ï¼ˆæ¨èï¼‰
                    </label>
                </div>
            </div>

            <form id="importForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="taskName">ä»»åŠ¡åç§°ï¼š</label>
                    <input type="text" id="taskName" name="name" class="form-control"
                           placeholder="ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ï¼šAIæ•°æ®å¯¼å…¥_20250120_1423">
                    <small class="form-text text-muted">
                        ğŸ’¡ ç•™ç©ºå°†æ ¹æ®å¯¼å…¥æ–¹å¼å’Œæ—¶é—´è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡åç§°
                    </small>
                </div>

                <input type="hidden" id="taskType" name="task_type" value="products">

                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div id="fileUploadArea" class="form-group" style="display: none;">
                    <label for="file">é€‰æ‹©äº§å“æ•°æ®æ–‡ä»¶ï¼š</label>
                    <div class="file-drop-zone" id="fileDropZone">
                        <p>ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p>æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
                        <p style="font-size: 12px; color: #888;">æ¨èä½¿ç”¨CSVæ ¼å¼ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§</p>
                    </div>
                    <input type="file" id="file" name="file_path" accept=".xlsx,.xls,.csv"
                           class="form-control" style="display: none;">
                </div>

                <!-- ç›´æ¥ç²˜è´´åŒºåŸŸ -->
                <div id="pasteArea" class="form-group">
                    <label for="pasteData">ç²˜è´´AIæ¨¡å‹è¾“å‡ºçš„è¡¨æ ¼æ•°æ®ï¼š</label>
                    <div style="margin-bottom: 10px; padding: 8px; background-color: #e3f2fd; border-radius: 3px; font-size: 12px;">
                        <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>ç›´æ¥ä»AIæ¨¡å‹å¤åˆ¶Markdownè¡¨æ ¼æ•°æ®</li>
                            <li>æˆ–è€…ä»Excel/Google Sheetså¤åˆ¶è¡¨æ ¼æ•°æ®</li>
                            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«è¡¨æ ¼æ ¼å¼å¹¶å¤„ç†</li>
                            <li>ç¡®ä¿åŒ…å«å®Œæ•´çš„è¡¨å¤´å’Œæ•°æ®è¡Œ</li>
                        </ul>
                    </div>
                    <textarea id="pasteData" name="paste_data" class="form-control"
                              rows="15" required
                              placeholder="è¯·åœ¨æ­¤å¤„ç²˜è´´è¡¨æ ¼æ•°æ®...

ç¤ºä¾‹æ ¼å¼ï¼š
| äº§å“æè¿° (Description) | äº§å“ç¼–ç  (Code) | ç³»åˆ— (Series) | ... |
| :--- | :--- | :--- | :--- |
| å•é—¨åº•æŸœ<br>1 door base unit<br>H.720 D.560 | N-U30-7256-L/R | N | U | ... |

æˆ–è€…ç›´æ¥ç²˜è´´ä»Excelå¤åˆ¶çš„æ•°æ®ï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”ï¼‰"></textarea>
                </div>

                <button type="submit" class="btn btn-success">ğŸš€ å¼€å§‹å¯¼å…¥äº§å“æ•°æ®</button>
            </form>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="progress-container" id="progressContainer">
            <h3>å¯¼å…¥è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡†å¤‡å¼€å§‹...</div>
        </div>

        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="resultContainer"></div>

        <!-- ä½¿ç”¨è¯´æ˜åŒºåŸŸ -->
        <div class="section">
            <h2>3. ä½¿ç”¨è¯´æ˜</h2>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h4>ğŸ“‹ æ•°æ®å‡†å¤‡æ­¥éª¤ï¼š</h4>
                <ol>
                    <li><strong>AIè¯†åˆ«æ•°æ®ï¼š</strong>ä½¿ç”¨AIå·¥å…·è¯†åˆ«PDFå›¾å†Œï¼Œè·å¾—äº§å“ç¼–ç ã€æè¿°ã€ä»·æ ¼ç­‰æ•°æ®</li>
                    <li><strong>æ•°æ®æ•´ç†ï¼š</strong>å°†AIè¯†åˆ«çš„æ•°æ®æ•´ç†åˆ°Excelæ¨¡æ¿ä¸­</li>
                    <li><strong>å¿…å¡«å­—æ®µï¼š</strong>ç¡®ä¿å¡«å†™äº§å“ç¼–ç å’Œäº§å“æè¿°ä¸¤ä¸ªå¿…å¡«å­—æ®µ</li>
                    <li><strong>ä»·æ ¼ä¿¡æ¯ï¼š</strong>è‡³å°‘å¡«å†™ä¸€ä¸ªä»·æ ¼ç­‰çº§ï¼ˆIIã€IIIã€IVã€Vï¼‰</li>
                    <li><strong>ä¸Šä¼ å¯¼å…¥ï¼š</strong>ä¸Šä¼ Excelæ–‡ä»¶ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¹¶åˆ›å»ºå®Œæ•´äº§å“ä¿¡æ¯</li>
                </ol>

                <h4>ğŸ¯ æ”¯æŒçš„æ•°æ®æ ¼å¼ç¤ºä¾‹ï¼š</h4>
                <div style="background-color: white; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px;">
                    äº§å“ç¼–ç : N-U30-7256-L/R<br>
                    äº§å“æè¿°: å•é—¨åº•æŸœ 1 door base unit H.720 D.560<br>
                    ä»·æ ¼ç­‰çº§II: 3730.00<br>
                    ä»·æ ¼ç­‰çº§III: 3970.00<br>
                    å¤‡æ³¨è¯´æ˜: ä¸€å—å¯è°ƒèŠ‚éš”æ¿
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ -->
        <div class="section">
            <h2>4. æœ€è¿‘çš„Royanaå¯¼å…¥ä»»åŠ¡</h2>
            <button onclick="loadTasks()" class="btn">ğŸ”„ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨</button>
            <div id="tasksContainer">
                <p>æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨...</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTaskId = null;
        let progressInterval = null;

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            setupFileDropZone();
            setupForm();
            loadTasks();
        });

        // è®¾ç½®æ–‡ä»¶æ‹–æ‹½åŒºåŸŸ
        function setupFileDropZone() {
            const dropZone = document.getElementById('fileDropZone');
            const fileInput = document.getElementById('file');

            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateFileDropZone(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDropZone(e.target.files[0]);
                }
            });
        }

        // æ›´æ–°æ–‡ä»¶æ‹–æ‹½åŒºåŸŸæ˜¾ç¤º
        function updateFileDropZone(file) {
            const dropZone = document.getElementById('fileDropZone');
            dropZone.innerHTML = `
                <p><strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong> ${file.name}</p>
                <p><strong>æ–‡ä»¶å¤§å°ï¼š</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <p>ç‚¹å‡»é‡æ–°é€‰æ‹©æ–‡ä»¶</p>
            `;
        }

        // è®¾ç½®è¡¨å•æäº¤
        function setupForm() {
            const form = document.getElementById('importForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        // å¤„ç†è¡¨å•æäº¤
        async function handleFormSubmit(e) {
            e.preventDefault();

            const progressContainer = document.getElementById('progressContainer');
            const resultContainer = document.getElementById('resultContainer');
            const importMethod = document.querySelector('input[name="importMethod"]:checked').value;

            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressContainer.style.display = 'block';
            resultContainer.innerHTML = '';

            try {
                let response;

                if (importMethod === 'paste') {
                    // å¤„ç†ç²˜è´´æ•°æ®å¯¼å…¥
                    const pasteData = document.getElementById('pasteData').value.trim();
                    let taskName = document.getElementById('taskName').value.trim();

                    if (!pasteData) {
                        throw new Error('è¯·ç²˜è´´è¡¨æ ¼æ•°æ®');
                    }

                    // å¦‚æœä»»åŠ¡åç§°ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
                    if (!taskName) {
                        taskName = generateDefaultTaskName();
                        document.getElementById('taskName').value = taskName;
                    }

                    // å¤„ç†ç²˜è´´çš„æ•°æ®
                    let csvData;
                    try {
                        csvData = processPasteData(pasteData);
                        console.log('æ•°æ®å¤„ç†æˆåŠŸï¼Œå‡†å¤‡å‘é€åˆ°æœåŠ¡å™¨');
                    } catch (error) {
                        console.error('æ•°æ®å¤„ç†å¤±è´¥:', error);
                        throw new Error(`æ•°æ®æ ¼å¼å¤„ç†å¤±è´¥: ${error.message}`);
                    }

                    // è·å–æ¨¡æ¿ç±»å‹
                    const templateType = document.querySelector('input[name="templateType"]:checked').value;

                    const formData = new FormData();
                    formData.append('name', taskName);
                    formData.append('task_type', 'products');
                    formData.append('template_type', templateType);
                    formData.append('csv_data', csvData);

                    response = await fetch('/products/ai-data/import/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                } else {
                    // å¤„ç†æ–‡ä»¶ä¸Šä¼ å¯¼å…¥
                    let taskName = document.getElementById('taskName').value.trim();

                    // å¦‚æœä»»åŠ¡åç§°ä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆ
                    if (!taskName) {
                        taskName = generateDefaultTaskName();
                        document.getElementById('taskName').value = taskName;
                    }

                    // ç»Ÿä¸€ä½¿ç”¨AIæ•°æ®å¯¼å…¥æ¥å£ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ 
                    const formData = new FormData(e.target);

                    // æ·»åŠ æ¨¡æ¿ç±»å‹ä¿¡æ¯
                    const templateType = document.querySelector('input[name="templateType"]:checked').value;
                    formData.append('template_type', templateType);

                    response = await fetch('/products/ai-data/import/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCsrfToken()
                        }
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'å¯¼å…¥ä»»åŠ¡åˆ›å»ºå¤±è´¥');
                }

                const result = await response.json();

                if (importMethod === 'paste' && result.success !== undefined) {
                    // AIæ•°æ®å¯¼å…¥çš„ç›´æ¥ç»“æœ
                    progressContainer.style.display = 'none';
                    if (result.success) {
                        showAlert(`âœ… å¯¼å…¥å®Œæˆï¼${result.message}`, 'success');
                    } else {
                        showAlert(`âŒ å¯¼å…¥å¤±è´¥ï¼š${result.error}`, 'danger');
                    }
                } else {
                    // ä¼ ç»Ÿå¯¼å…¥ä»»åŠ¡ï¼Œéœ€è¦ç›‘æ§è¿›åº¦
                    currentTaskId = result.id || result.task_id;
                    startProgressMonitoring();
                }

            } catch (error) {
                console.error('å¯¼å…¥é”™è¯¯:', error);
                showAlert('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'danger');
                progressContainer.style.display = 'none';
            }
        }

        // å¼€å§‹ç›‘æ§è¿›åº¦
        function startProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/import-tasks/${currentTaskId}/progress/`);
                    const data = await response.json();
                    
                    updateProgress(data);
                    
                    if (data.status === 'completed' || data.status === 'failed' || data.status === 'partial') {
                        clearInterval(progressInterval);
                        showResult(data);
                        loadTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    }
                } catch (error) {
                    console.error('è·å–è¿›åº¦å¤±è´¥:', error);
                }
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(data) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = data.progress + '%';
            progressText.textContent = `${data.status_display} - ${data.progress.toFixed(1)}% (${data.processed_rows}/${data.total_rows})`;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(data) {
            const resultContainer = document.getElementById('resultContainer');
            let alertClass = 'alert-info';
            let message = '';
            
            if (data.status === 'completed') {
                alertClass = 'alert-success';
                message = `å¯¼å…¥æˆåŠŸï¼å…±å¤„ç† ${data.total_rows} è¡Œæ•°æ®ï¼ŒæˆåŠŸ ${data.success_rows} è¡Œã€‚`;
            } else if (data.status === 'failed') {
                alertClass = 'alert-danger';
                message = `å¯¼å…¥å¤±è´¥ï¼š${data.error_details || 'æœªçŸ¥é”™è¯¯'}`;
            } else if (data.status === 'partial') {
                alertClass = 'alert-info';
                message = `å¯¼å…¥éƒ¨åˆ†æˆåŠŸã€‚å…±å¤„ç† ${data.total_rows} è¡Œæ•°æ®ï¼ŒæˆåŠŸ ${data.success_rows} è¡Œï¼Œå¤±è´¥ ${data.error_rows} è¡Œã€‚`;
            }
            
            resultContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                    ${data.error_rows > 0 ? `<br><a href="/api/import-tasks/${currentTaskId}/download_error_report/" class="btn btn-secondary" style="margin-top: 10px;">ä¸‹è½½é”™è¯¯æŠ¥å‘Š</a>` : ''}
                </div>
            `;
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                const response = await fetch('/api/import-tasks/?ordering=-created_at&limit=10');
                const data = await response.json();
                
                const tasksContainer = document.getElementById('tasksContainer');
                
                if (data.results && data.results.length > 0) {
                    tasksContainer.innerHTML = `
                        <table class="tasks-table">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>ç±»å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>è¿›åº¦</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.results.map(task => `
                                    <tr>
                                        <td>${task.name}</td>
                                        <td>${task.type_display}</td>
                                        <td><span class="status-badge status-${task.status}">${task.status_display}</span></td>
                                        <td>${task.progress.toFixed(1)}%</td>
                                        <td>${new Date(task.created_at).toLocaleString()}</td>
                                        <td>
                                            ${task.error_rows > 0 ? `<a href="/api/import-tasks/${task.id}/download_error_report/" class="btn btn-secondary" style="font-size: 12px; padding: 4px 8px;">é”™è¯¯æŠ¥å‘Š</a>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    tasksContainer.innerHTML = '<p>æš‚æ— å¯¼å…¥ä»»åŠ¡</p>';
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        // ä¸‹è½½æ¨¡æ¿
        function downloadTemplate() {
            const includeSample = document.getElementById('includeSample').checked;
            const templateType = document.querySelector('input[name="templateType"]:checked').value;

            let url, filename;

            if (templateType === 'ai_data') {
                // AIæ•°æ®æ ¼å¼æ¨¡æ¿
                const params = new URLSearchParams({
                    include_sample: includeSample ? 'true' : 'false'
                });
                url = `/products/ai-data/template/download/?${params.toString()}`;
                const sampleSuffix = includeSample ? '_å«ç¤ºä¾‹æ•°æ®' : '';
                filename = `AIæ•°æ®æ ¼å¼å¯¼å…¥æ¨¡æ¿${sampleSuffix}.csv`;
            } else {
                // Royanaä¼ ç»Ÿæ ¼å¼æ¨¡æ¿
                const params = new URLSearchParams({
                    template_type: 'royana_import',
                    format: 'csv',
                    include_sample: includeSample ? 'true' : 'false'
                });
                url = `/products/royana/template/download/?${params.toString()}`;
                const sampleSuffix = includeSample ? '_å«ç¤ºä¾‹æ•°æ®' : '';
                filename = `Royanaæ•´æœ¨å®šåˆ¶äº§å“å¯¼å…¥æ¨¡æ¿${sampleSuffix}.csv`;
            }

            // ä½¿ç”¨fetchä¸‹è½½æ–‡ä»¶
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ä¸‹è½½å¤±è´¥');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    const objectUrl = URL.createObjectURL(blob);
                    link.href = objectUrl;
                    link.download = filename;

                    // è§¦å‘ä¸‹è½½
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // æ¸…ç†URLå¯¹è±¡
                    URL.revokeObjectURL(objectUrl);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const templateName = templateType === 'ai_data' ? 'AIæ•°æ®æ ¼å¼' : 'Royanaä¼ ç»Ÿæ ¼å¼';
                    showAlert(`âœ… ${templateName}å¯¼å…¥æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼è¯·å‚è€ƒCSVæ–‡ä»¶ä¸­çš„å­—æ®µè¯´æ˜å’Œç¤ºä¾‹æ•°æ®æ ¼å¼å¡«å†™äº§å“ä¿¡æ¯ã€‚`, 'success');
                })
                .catch(error => {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    showAlert('âŒ æ¨¡æ¿ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
                });
        }

        // ç”Ÿæˆé»˜è®¤ä»»åŠ¡åç§°
        function generateDefaultTaskName() {
            const now = new Date();
            const templateType = document.querySelector('input[name="templateType"]:checked').value;
            const importMethod = document.querySelector('input[name="importMethod"]:checked').value;

            // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');

            const dateStr = `${year}${month}${day}`;
            const timeStr = `${hour}${minute}`;

            // æ ¹æ®æ¨¡æ¿ç±»å‹å’Œå¯¼å…¥æ–¹å¼ç”Ÿæˆåç§°
            let prefix = '';
            if (templateType === 'ai_data') {
                prefix = importMethod === 'paste' ? 'AIæ•°æ®ç²˜è´´å¯¼å…¥' : 'AIæ•°æ®æ–‡ä»¶å¯¼å…¥';
            } else {
                prefix = importMethod === 'paste' ? 'Royanaç²˜è´´å¯¼å…¥' : 'Royanaæ–‡ä»¶å¯¼å…¥';
            }

            return `${prefix}_${dateStr}_${timeStr}`;
        }

        // å¯¼å…¥æ–¹å¼åˆ‡æ¢äº‹ä»¶
        function toggleImportMethod() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const pasteArea = document.getElementById('pasteArea');
            const fileInput = document.getElementById('file');
            const pasteInput = document.getElementById('pasteData');
            const importMethod = document.querySelector('input[name="importMethod"]:checked').value;

            if (importMethod === 'paste') {
                fileUploadArea.style.display = 'none';
                pasteArea.style.display = 'block';
                fileInput.required = false;
                pasteInput.required = true;
            } else {
                fileUploadArea.style.display = 'block';
                pasteArea.style.display = 'none';
                fileInput.required = true;
                pasteInput.required = false;
            }

            // æ›´æ–°ä»»åŠ¡åç§°placeholder
            updateTaskNamePlaceholder();
        }

        // æ›´æ–°ä»»åŠ¡åç§°placeholder
        function updateTaskNamePlaceholder() {
            const taskNameInput = document.getElementById('taskName');
            const defaultName = generateDefaultTaskName();
            taskNameInput.placeholder = `ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆï¼š${defaultName}`;
        }

        // å¤„ç†ç²˜è´´æ•°æ®
        function processPasteData(pasteData) {
            try {
                console.log('åŸå§‹ç²˜è´´æ•°æ®é•¿åº¦:', pasteData.length);
                console.log('åŸå§‹æ•°æ®å‰200å­—ç¬¦:', pasteData.substring(0, 200));

                // æ£€æµ‹æ•°æ®æ ¼å¼
                if (pasteData.includes('|') && (pasteData.includes('---') || pasteData.includes(':---'))) {
                    // Markdownè¡¨æ ¼æ ¼å¼
                    console.log('æ£€æµ‹åˆ°Markdownè¡¨æ ¼æ ¼å¼');
                    const result = parseMarkdownTable(pasteData);
                    console.log('è½¬æ¢åCSVæ•°æ®é•¿åº¦:', result.length);
                    console.log('è½¬æ¢åæ•°æ®å‰200å­—ç¬¦:', result.substring(0, 200));
                    return result;
                } else if (pasteData.includes('\t')) {
                    // åˆ¶è¡¨ç¬¦åˆ†éš”æ ¼å¼ï¼ˆExcelå¤åˆ¶ï¼‰
                    console.log('æ£€æµ‹åˆ°åˆ¶è¡¨ç¬¦åˆ†éš”æ ¼å¼');
                    return parseTabDelimitedData(pasteData);
                } else if (pasteData.includes(',')) {
                    // CSVæ ¼å¼
                    console.log('æ£€æµ‹åˆ°CSVæ ¼å¼');
                    return pasteData;
                } else {
                    throw new Error('æ— æ³•è¯†åˆ«çš„æ•°æ®æ ¼å¼ï¼Œè¯·ç¡®ä¿æ•°æ®ä¸ºè¡¨æ ¼æ ¼å¼ã€‚æ”¯æŒçš„æ ¼å¼ï¼šMarkdownè¡¨æ ¼ã€åˆ¶è¡¨ç¬¦åˆ†éš”ã€CSVæ ¼å¼');
                }
            } catch (error) {
                console.error('æ•°æ®å¤„ç†é”™è¯¯:', error);
                throw error;
            }
        }

        // è§£æMarkdownè¡¨æ ¼ - æ›´å¥å£®çš„ç‰ˆæœ¬
        function parseMarkdownTable(markdownData) {
            try {
                const lines = markdownData.trim().split('\n');
                const csvLines = [];

                console.log('å¼€å§‹è§£æMarkdownè¡¨æ ¼ï¼Œæ€»è¡Œæ•°:', lines.length);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    // è·³è¿‡ç©ºè¡Œ
                    if (!line) {
                        continue;
                    }

                    // è·³è¿‡åˆ†éš”è¡Œï¼ˆåŒ…å« --- çš„è¡Œï¼‰
                    if (line.includes('---') || line.includes(':---')) {
                        console.log(`è·³è¿‡åˆ†éš”è¡Œ ${i+1}:`, line);
                        continue;
                    }

                    // å¤„ç†è¡¨æ ¼è¡Œ
                    if (line.startsWith('|') && line.endsWith('|')) {
                        console.log(`å¤„ç†è¡¨æ ¼è¡Œ ${i+1}:`, line);

                        try {
                            // ç§»é™¤é¦–å°¾çš„ | ç¬¦å·
                            const cellContent = line.slice(1, -1);

                            // åˆ†å‰²å•å…ƒæ ¼ï¼Œä½†è¦å°å¿ƒå¤„ç†åŒ…å« | çš„å†…å®¹
                            const cells = [];
                            let currentCell = '';
                            let inQuotes = false;

                            for (let j = 0; j < cellContent.length; j++) {
                                const char = cellContent[j];

                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                    currentCell += char;
                                } else if (char === '|' && !inQuotes) {
                                    // æ‰¾åˆ°å•å…ƒæ ¼åˆ†éš”ç¬¦
                                    cells.push(currentCell.trim());
                                    currentCell = '';
                                } else {
                                    currentCell += char;
                                }
                            }

                            // æ·»åŠ æœ€åä¸€ä¸ªå•å…ƒæ ¼
                            if (currentCell !== '') {
                                cells.push(currentCell.trim());
                            }

                            // å¤„ç†æ¯ä¸ªå•å…ƒæ ¼
                            const processedCells = cells.map(cell => {
                                // æ¸…ç†å•å…ƒæ ¼å†…å®¹
                                let cleanCell = cell.trim();

                                // å¤„ç†<br>æ¢è¡Œç¬¦ - è½¬æ¢ä¸ºå®é™…æ¢è¡Œç¬¦
                                cleanCell = cleanCell.replace(/<br\s*\/?>/gi, '\n');

                                // å¤„ç†å…¶ä»–HTMLæ ‡ç­¾
                                cleanCell = cleanCell.replace(/<[^>]*>/g, '');

                                // å¦‚æœåŒ…å«é€—å·ã€æ¢è¡Œç¬¦æˆ–å¼•å·ï¼Œç”¨å¼•å·åŒ…å›´å¹¶è½¬ä¹‰å†…éƒ¨å¼•å·
                                if (cleanCell.includes(',') || cleanCell.includes('\n') || cleanCell.includes('"')) {
                                    cleanCell = '"' + cleanCell.replace(/"/g, '""') + '"';
                                }

                                return cleanCell;
                            });

                            csvLines.push(processedCells.join(','));
                            console.log(`æˆåŠŸå¤„ç†è¡Œ ${i+1}ï¼Œå•å…ƒæ ¼æ•°:`, processedCells.length);

                        } catch (cellError) {
                            console.error(`å¤„ç†è¡Œ ${i+1} æ—¶å‡ºé”™:`, cellError);
                            // ç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
                        }
                    }
                }

                console.log('Markdownè¡¨æ ¼è§£æå®Œæˆï¼ŒCSVè¡Œæ•°:', csvLines.length);
                return csvLines.join('\n');

            } catch (error) {
                console.error('Markdownè¡¨æ ¼è§£æå¤±è´¥:', error);
                throw new Error(`Markdownè¡¨æ ¼è§£æå¤±è´¥: ${error.message}`);
            }
        }

        // è§£æåˆ¶è¡¨ç¬¦åˆ†éš”æ•°æ®
        function parseTabDelimitedData(tabData) {
            const lines = tabData.trim().split('\n');
            const csvLines = [];

            for (const line of lines) {
                const cells = line.split('\t').map(cell => {
                    let cleanCell = cell.trim();
                    // å¦‚æœåŒ…å«é€—å·æˆ–å¼•å·ï¼Œç”¨å¼•å·åŒ…å›´
                    if (cleanCell.includes(',') || cleanCell.includes('"')) {
                        cleanCell = '"' + cleanCell.replace(/"/g, '""') + '"';
                    }
                    return cleanCell;
                });
                csvLines.push(cells.join(','));
            }

            return csvLines.join('\n');
        }

        // æ¨¡æ¿ç±»å‹åˆ‡æ¢äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æ¨¡æ¿ç±»å‹åˆ‡æ¢
            const templateRadios = document.querySelectorAll('input[name="templateType"]');
            const royanaDescription = document.getElementById('royanaDescription');
            const aiDescription = document.getElementById('aiDescription');

            templateRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'ai_data') {
                        royanaDescription.style.display = 'none';
                        aiDescription.style.display = 'block';
                    } else {
                        royanaDescription.style.display = 'block';
                        aiDescription.style.display = 'none';
                    }
                    // æ›´æ–°ä»»åŠ¡åç§°placeholder
                    updateTaskNamePlaceholder();
                });
            });

            // å¯¼å…¥æ–¹å¼åˆ‡æ¢
            const importMethodRadios = document.querySelectorAll('input[name="importMethod"]');
            importMethodRadios.forEach(radio => {
                radio.addEventListener('change', toggleImportMethod);
            });

            // åˆå§‹åŒ–å¯¼å…¥æ–¹å¼å’Œä»»åŠ¡åç§°placeholder
            toggleImportMethod();
            updateTaskNamePlaceholder();
        });

        // è·å–CSRFä»¤ç‰Œ
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
        // æ˜¾ç¤ºå¿«é€Ÿç»Ÿè®¡
        async function showQuickStats() {
            try {
                const response = await fetch('/products/admin/data-summary/');
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    let message = `ğŸ“Š æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯\n\n`;
                    message += `æ€»è®°å½•æ•°: ${data.total_records.toLocaleString()}\n\n`;

                    for (const [categoryName, categoryData] of Object.entries(data.categories)) {
                        const displayName = {
                            'products': 'äº§å“æ•°æ®',
                            'attributes': 'å±æ€§æ•°æ®',
                            'metadata': 'åŸºç¡€æ•°æ®',
                            'import_history': 'å¯¼å…¥å†å²'
                        }[categoryName] || categoryName;

                        if (categoryData.count > 0) {
                            message += `${displayName}: ${categoryData.count} æ¡\n`;
                            for (const [detailName, detailCount] of Object.entries(categoryData.details)) {
                                if (detailCount > 0) {
                                    message += `  â€¢ ${detailName}: ${detailCount}\n`;
                                }
                            }
                            message += '\n';
                        }
                    }

                    alert(message);
                } else {
                    alert('è·å–æ•°æ®ç»Ÿè®¡å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
    </script>
</body>
</html>